<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>UP-Tests SPA Main page</title>
    <script>
        var globalSessionId;
        var responseStatus;
        var responseText;
        var checkedTestId;
        var checkedCommon;
        var checkedTestIdJson;

        function parse_response_populate_tests(tests_json){
          globalSessionId = tests_json.session.id;
          console.log("SessionId : ",globalSessionId);
          const tests_container = document.getElementById("test_list");
            for (test of tests_json.tests) {
                //console.log(test);
                tests_container.innerHTML += `<input type="checkbox" id="test_${test.id}" name="test_${test.id}" ><label for="test_${test.id}" class="test_undefined">${test.name}</label><br/>`;
            }
        }

        function loadFile(file){
            return new Promise(resolve=>{
                let reader = new FileReader()
                reader.onload = function(event) {
                    let data = event.target.result
                    resolve(data)
                }
                reader.readAsText(file)
            })
        }

        async function loadJsonTests() {
             console.log('Begin loading new JSON file with tests into server.');
             var file = fileupload.files[0];
             var fileContent = await loadFile(file);
             console.log('-- request ----------------------------------------------');
             console.log(fileContent);
             console.log('---------------------------------------------------------');
               const response = await fetch(`load_test`, {
                    method: "POST",
                    headers: {
                     'Accept': 'application/json',
                     'Content-Type': 'application/json'
                    },
                    body: fileContent
                  });
               responseStatus = response.status;
                   if (responseStatus == 400) {
                     console.log('-- error ----------------------------------------------');
                     console.log('Response status = ',responseStatus);
                     responseText = await response.text();
                     console.log('Response text = ',responseText);
                     console.log('---------------------------------------------------------');
                     return response;
                   } else {
                     return response.json();
                   }
        }

        async function btnUploadTestFile() {
             const resultJson = await loadJsonTests();
             console.log('-- response ---------------------------------------------');
             console.log(resultJson);
             console.log('---------------------------------------------------------');
             const tests_container = document.getElementById("test_list");
               if (responseStatus == 400) {
                 tests_container.className = 'error_msg';
                 tests_container.innerHTML = `ERROR:<br/> ${JSON.parse(responseText).message}`;
               } else {
                 tests_container.classList.remove('error_msg');
                 tests_container.innerHTML = "";
                 parse_response_populate_tests(resultJson);
               }
        }

        async function startJsonTests() {
             console.log('Send id of test to execting.');
             console.log('-- request ----------------------------------------------');
             console.log(checkedTestIdJson);
             console.log('---------------------------------------------------------');
               const response = await fetch(`start_test`, {
                    method: "POST",
                    headers: {
                     'Accept': 'application/json',
                     'Content-Type': 'application/json'
                    },
                    body: checkedTestIdJson
                  });
               responseStatus = response.status;
                   if (responseStatus == 400) {
                     console.log('-- error ----------------------------------------------');
                     console.log('Response status = ',responseStatus);
                     responseText = await response.text();
                     console.log('Response text = ',responseText);
                     console.log('---------------------------------------------------------');
                     return response;
                   } else {
                     return response.json();
                   }
        }

        async function btnStartTests(){
          console.log('-- start tests ---------------------------------------------');
          const tests_container = document.getElementById("test_list");
          checkedTestId = Array.from(tests_container.querySelectorAll("input[type=checkbox]:checked"))
            .map((elem) => parseInt(elem.id.replace("test_","")));
          checkedCommon = "{\"sid\" : \"" + globalSessionId + "\" , \"ids\" : "+JSON.stringify(checkedTestId)+"}";
          console.log("checkedCommon = ",checkedCommon);
          checkedTestIdJson = JSON.parse(JSON.stringify(checkedCommon));
          console.log("checkedTestIdJson = ",checkedTestIdJson);
             const resultJson = await startJsonTests();
             console.log('-- response ---------------------------------------------');
             console.log(resultJson);
             console.log('---------------------------------------------------------');
        }

    </script>
    <style type="text/css">
<!--
body {
	color:#000000;
	margin:0;
}
.label {
    width: 180px;
    height: 50px;
    border-radius: 4px;
    text-align: center;
    cursor: pointer;
    display: block;
    font: 14px/50px Tahoma;
    transition: all 0.18s ease-in-out;
    border: 1px solid #333;
    color: #333;
}
.test_container { border:1px solid #ccc; width:100%; height: 200px; overflow-y: scroll; top: 0;  left: 0;}

.test_undefined{color: black;}
.test_fail{color: red;}
.test_success{color: green;}
.test_executing{color: grey;}

.error_msg{color: red; font-size: 16px;}
-->
</style>
</head>
<body>
<table width="100%" border="2">
    <tr>
        <td width="70%" height="200px">
            <input id="fileupload" type="file" accept=".json" name="fileupload" />
            <br><br>
            <div id="btn_upload_test_file" onclick="btnUploadTestFile()"  class="label">send json file</div>
        </td><td>2</td>
    </tr>
    <tr>
        <td height="600px" >
            <div id="test_list" class="test_container">
            </div>
        </td><td>4</td>
    </tr>
    <tr>
        <td height="100px">
            <br><br>
            <div id="btn_start_tests" onclick="btnStartTests()" class="label">Start tests</div>
        </td><td>6</td>
    </tr>
</table>
</body>
</html>